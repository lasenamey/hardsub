name: Encode Video Hardsub 1080p (Manual URL)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct URL video (mp4/mkv/avi)"
        required: true
        type: string
      srt_url:
        description: "Direct URL subtitle (.srt atau .vtt)"
        required: true
        type: string
      output_name:
        description: "Nama file output (tanpa .mp4)"
        required: false
        default: "encoded_video"
        type: string

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg jq curl fonts-crosextra-carlito

      - name: Download Video & Subtitle
        run: |
          echo "Download video..."
          curl -L "${{ inputs.video_url }}" -o input_video
          
          echo "Download subtitle..."
          # Download ke file sementara (raw_sub) lalu convert ke SRT standar
          # Ini otomatis menangani VTT maupun SRT agar kompatibel dengan filter hardsub
          curl -L "${{ inputs.srt_url }}" -o raw_sub
          ffmpeg -i raw_sub subtitle.srt

      - name: Encode Video (H264 + AAC + 1080p + Hardsub)
        run: |
          ffmpeg -y \
            -i input_video \
            -vf "subtitles=subtitle.srt:force_style='FontName=Segoe UI,FontSize=18,PrimaryColour=&H00FFFF&,Outline=1,Shadow=0',scale=1920:1080" \
            -c:v libx264 \
            -profile:v high \
            -level 4.2 \
            -pix_fmt yuv420p \
            -preset slow \
            -crf 18 \
            -c:a aac \
            -b:a 192k \
            "${{ inputs.output_name }}.mp4"

      - name: Get Upload Server
        run: |
          RESPONSE=$(curl -s "https://up4stream.com/api/upload/server?key=${{ secrets.UP4STREAM_KEY }}")
          echo "$RESPONSE"
          SERVER=$(echo "$RESPONSE" | jq -r '.result')
          echo "UPLOAD_SERVER=$SERVER" >> $GITHUB_ENV

      - name: Upload to Up4Stream
        run: |
          curl -X POST \
            -F "key=${{ secrets.UP4STREAM_KEY }}" \
            -F "file=@${{ inputs.output_name }}.mp4" \
            "$UPLOAD_SERVER"
