name: Convert MKV to MP4 with Hardsub

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  convert-videos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup rclone configuration
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Install rclone
      run: |
        curl -O https://downloads.rclone.org/rclone-current-linux-amd64.deb
        sudo dpkg -i rclone-current-linux-amd64.deb
        rm rclone-current-linux-amd64.deb

    - name: Install FFmpeg
      run: |
        sudo apt update
        sudo apt install -y ffmpeg

    - name: Create working directories
      run: |
        mkdir -p input output

    - name: Download MKV and SRT files from Google Drive
      run: |
        rclone copy "gdrive:${{ secrets.GDRIVE_FOLDER_PATH }}" input \
          --include "*.mkv" --include "*.srt" \
          --progress --verbose

    - name: Process videos with hardsub
      run: |
        cd input
        for mkv_file in *.mkv; do
          if [ -f "$mkv_file" ]; then
            base_name="${mkv_file%.*}"
            srt_file="${base_name}.srt"
            output_file="${base_name}.mp4"
            
            echo "Processing: $mkv_file"
            
            if [ -f "$srt_file" ]; then
              echo "Found matching subtitle: $srt_file"
              cd ..
              ffmpeg -i "input/$mkv_file" \
                -vf "subtitles=input/$srt_file:force_style='FontName=Arial,FontSize=18'" \
                -c:v libx264 -crf 18 -preset medium \
                -c:a copy \
                -y "output/$output_file"
              cd input
            else
              echo "No matching subtitle found for $mkv_file, skipping..."
            fi
          fi
        done

    - name: Upload processed videos to Google Drive
      run: |
        rclone copy output "gdrive:${{ secrets.GDRIVE_FOLDER_PATH }}/hardsub" \
          --progress --verbose

    - name: Clean up
      run: |
        rm -rf input output
