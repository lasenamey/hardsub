name: Convert MKV to MP4 Hardsub Bro

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore rclone config
        run: |
          echo "$RCLONE_CONF_BASE64" | base64 -d > ~/.config/rclone/rclone.conf
        env:
          RCLONE_CONF_BASE64: ${{ secrets.RCLONE_CONF_BASE64 }}

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Debug Google Drive (cek dulu)
        run: rclone lsd gdrive:

      - name: Download MKV + SRT
        run: |
          mkdir input
          rclone copy "gdrive:${{ secrets.GDRIVE_FOLDER_ID }}" input \
            --include "*.mkv" --include "*.srt" --fast-list

      - name: Convert MKV + SRT to MP4 hardsub
        run: |
          mkdir output
          for mkv in input/*.mkv; do
            base=$(basename "$mkv" .mkv)
            srt="input/${base}.srt"
            out="output/${base}.mp4"

            if [[ -f "$srt" ]]; then
              echo "Converting $base..."
              ffmpeg -i "$mkv" -vf "subtitles='${srt}'" -c:v libx264 -crf 18 -preset medium -c:a copy "$out"
            else
              echo "Tidak ada SRT untuk $base â†’ SKIP"
            fi
          done

      - name: Upload Result
        run: |
          rclone copy output "gdrive:${{ secrets.GDRIVE_FOLDER_ID }}/hardsub" --progress
